<!-- Snorkungen 2024 - gradient-js-clock -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradient Clock</title>
    <link rel="shortcut icon" href="#" />

    <style>
        :root {
            --background-color: #e3e3e3;
            --foreground-color: #2c2c2c;
        }

        html,
        body,
        #root {
            margin: 0;
            padding: 0;
            box-sizing: border-box;

            background-color: var(--background-color);
            color: var(--foreground-color);

            text-align: center;
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;

            height: 100%;
            width: 100%;

            display: flex;
            justify-content: center;
            align-items: center;
        }

        #root {
            font-size: 3em;
            border-radius: 2rem;

            position: relative;
            aspect-ratio: 1 / 1;

            width: fit-content;
            height: auto;
            padding: 2em;
        }

        #root canvas {
            border-radius: 2rem;

            width: 100%;
            height: 100%;
            position: absolute;
            z-index: 0;
        }

        #root h1 {
            margin: 0;
            padding: 0;
            z-index: 9;

            background-color: var(--background-color);
            width: fit-content;
            padding: 1rem;
            border-radius: 2rem;
        }
    </style>

    <script>
        const RGBToHSL = ([red, green, blue]) => {
            red /= 255; green /= 255; blue /= 255;
            let max = Math.max(red, green, blue),
                min = Math.min(red, green, blue);
            let hue = 0,
                saturation,
                lightness = (max + min) / 2;


            if (max === min) {
                hue = saturation = 0;
            } else {
                let diff = max - min;
                saturation = lightness > 0.5 ? diff / (2 - max - min) : diff / (max + min);

                switch (max) {
                    case red:
                        hue = (green - blue) / diff + (green < blue ? 6 : 0);
                        break;
                    case green:
                        hue = (blue - red) / diff + 2;
                        break;
                    case blue:
                        hue = (red - green) / diff + 4;
                        break;
                }

                hue = hue / 6;
            }

            return [hue, saturation, lightness];
        }

        const HSLToRGB = ([hue, saturation, lightness]) => {
            hue = Math.round(hue * 360);

            let a = saturation * Math.min(lightness, 1 - lightness);
            let f = (
                n,
                k = (n + (hue / 30)) % 12
            ) => lightness - a * Math.max(-1, Math.min(k - 3, 9 - k, 1));

            return [
                Math.ceil(f(0) * 255),
                Math.ceil(f(8) * 255),
                Math.ceil(f(4) * 255),
                1
            ]
        }
    </script>
    <script>


        /** @type {HTMLElement} */
        let root_element,
            /** @type {HTMLElement} */
            title_element,
            /** @type {HTMLElement} */
            favicon_element,
            /** @type {HTMLCanvasElement} */
            gradient_element,
            /** @type {CanvasRenderingContext2D} */
            ctx,
            /** @type {HTMLElement} */
            time_element;

        let colors = [
            [203, 34, 32],
            [103, 241, 32],
            [203, 34, 122],
            [203, 34, 322],
            [23, 34, 22],
            [23, 34, 32],
            [243, 34, 232],
            [3, 34, 32],
            [2, 124, 342],
            [203, 234, 35],
            [223, 34, 32],
            [213, 54, 32],
        ];

        function render_data() {
            let date = new Date(),
                hours = date.getHours(),
                minutes = date.getMinutes(),
                seconds = date.getSeconds();

            // determine colors based on time ...
            let color_idx = 1;
            let start = colors[color_idx], end = colors[color_idx];

            return {
                date,
                hours,
                minutes,
                seconds,
                milliseconds: date.getUTCMilliseconds(),

                rgb_start: start, rgb_end: end,
            };
        }

        const width = 20;
        let radius = (width - 1) / 2;
        let buffer = new Uint8ClampedArray(width * width * 4);
        let render_initialised = 0;

        function render() {
            let { hours, minutes, seconds, milliseconds, rgb_start, rgb_end } = render_data();
            // get time and stuff

            let time_string = `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

            title_element.textContent = time_string.substring(0, 5);
            time_element.textContent = time_string;

            // update image every 6 seconds
            if (render_initialised && seconds % 1 != 0) {
                return;
            }

            let begin = [234, 120, 0], end = [239, 130, 0];

            // determine target_angle based on seconds
            // seconds / 60 * 2* Math.PI - Math.PI / 2
            let target_angle = (1 - (seconds * 1000 + milliseconds) / (1000 * 60)) * 2 * Math.PI + Math.PI / 2, target_angle_fov = Math.PI / 2;

            // draw a circle for the vibes ...

            for (let i = 0; i < buffer.byteLength; i += 4) {
                let x = (i % (width * 4)) / 4, y = Math.floor(i / (width * 4));
                let ox = x - ((width - 1) / 2), oy = ((width - 1) / 2) - y; // values with the origin in the middle of the canvas

                // distance from center
                let dist = Math.sqrt(ox ** 2 + oy ** 2);
                // calculate angle
                // tan a = oy / ox
                let angle = Math.atan(oy / ox);

                // correct angle to a full rotation
                if (isNaN(angle)) {
                    angle = 0
                }

                if (oy >= 0 && ox >= 0) {
                    // Q1
                    angle = angle;
                } else if (oy >= 0 && ox <= 0) {
                    // Q2
                    angle = Math.PI + angle // the angle is negative
                } else if (oy < 0 && ox < 0) {
                    // Q3
                    angle = Math.PI + angle;
                } else {
                    // Q4
                    angle = 2 * Math.PI + angle
                }


                let distance_from_target_angle = Math.min(Math.abs(target_angle - angle), Math.abs(target_angle - angle + 2 * Math.PI), Math.abs(angle - target_angle + 2 * Math.PI));


                let lightness = ((width - y) / width) * (1 - (minutes / 60)) * 50 + 30; // 30% -> 80%
                let saturation = ((60 - minutes) / 60) * 40 + 30;
                let hue = (((hours % 2 == 0) ? (60 - minutes) : minutes) / 60) * 60 + 60 * ((360 / 60) * ((hours) / 24));

                if (dist > radius) {
                    let max_l = Math.sqrt(((width - 1) / 2) ** 2 + ((width - 1) / 2) ** 2);

                    lightness += ((dist - radius) / (max_l - radius)) * 8;
                }


                if (distance_from_target_angle < (target_angle_fov / 2)) {
                    lightness += 15 * (1 - (distance_from_target_angle * 2 / target_angle_fov))
                }



                let [r, g, b] = HSLToRGB([hue / 360, saturation / 100, lightness / 100])

                buffer[i] = r;
                buffer[i + 1] = g;
                buffer[i + 2] = b;

                buffer[i + 3] = 0xff;
            }

            let imdata = new ImageData(buffer, width, width);
            ctx.putImageData(imdata, 0, 0)

            favicon_element.href = gradient_element.toDataURL();
        }

        function initialise(event) {
            document.documentElement.style.setProperty("--background-color", "#1e1e1e")
            document.documentElement.style.setProperty("--foreground-color", "#efefee")

            root_element = document.getElementById("root");
            title_element = document.getElementsByTagName("title")[0];

            favicon_element = document.head.appendChild(document.createElement("link"));
            favicon_element.rel = "shortcut icon";
            favicon_element.href = "#";

            gradient_element = root_element.appendChild(document.createElement("canvas"));
            ctx = gradient_element.getContext("2d");
            time_element = root_element.appendChild(document.createElement("h1"));

            gradient_element.width = width;
            gradient_element.height = width;

            // draw something on the screen

            console.log("start render")
            render(); render_initialised = 1;
            window.setInterval(render, 100)
        }

        window.onload = initialise;
    </script>
</head>

<body>
    <div id="root"></div>
</body>

</html>